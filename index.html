<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkolaHub Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        .sidebar-link.active { background-color: #eff6ff; color: #2563eb; border-right: 3px solid #2563eb; }
        .hidden { display: none !important; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fa-spin-fast { animation: spin 0.6s linear infinite; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; border-radius: 12px; overflow: hidden; background: #000; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden font-sans">

    <!-- GLOBAL LOADER -->
    <div id="globalLoader" class="hidden fixed inset-0 z-[100] bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center">
        <div class="animate-spin w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full mb-3"></div>
        <p class="text-sm font-bold text-slate-600">Memproses...</p>
    </div>

    <!-- CMS MODAL (ADMIN) -->
    <div id="cmsModal" class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden m-4">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h3 class="font-bold text-lg text-slate-800">Urus Pusat Belajar</h3>
                    <p class="text-xs text-slate-500">Tambah Topik dan Bahan Pembelajaran</p>
                </div>
                <button onclick="toggleCMS(false)" class="text-slate-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="flex flex-1 overflow-hidden">
                <!-- Kiri: Senarai Topik -->
                <div class="w-1/3 border-r border-slate-100 bg-slate-50 flex flex-col">
                    <div class="p-3 border-b border-slate-100">
                        <button onclick="addNewTopic()" class="w-full bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 transition shadow-sm">
                            <i class="fas fa-plus mr-1"></i> Topik Baru
                        </button>
                    </div>
                    <div id="cmsTopicList" class="flex-1 overflow-y-auto p-2 space-y-1">
                        <!-- List Topik Dijana Di Sini -->
                    </div>
                </div>

                <!-- Kanan: Editor Kandungan -->
                <div class="w-2/3 flex flex-col bg-white">
                    <div id="cmsContentArea" class="flex-1 overflow-y-auto p-6 hidden">
                        <div class="flex justify-between items-start mb-6 border-b border-slate-100 pb-4">
                            <div class="flex-1 mr-4">
                                <label class="text-[10px] font-bold uppercase text-slate-400">Tajuk Topik</label>
                                <input id="editTopicTitle" type="text" class="w-full text-lg font-bold border-b border-slate-300 focus:border-blue-500 outline-none pb-1" placeholder="Nama Topik">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold uppercase text-slate-400">Ikon (FontAwesome)</label>
                                <input id="editTopicIcon" type="text" class="w-24 text-sm border-b border-slate-300 focus:border-blue-500 outline-none pb-1 font-mono" placeholder="fa-book">
                            </div>
                        </div>

                        <div class="mb-4 flex justify-between items-center">
                            <h4 class="font-bold text-slate-700 text-sm">Bahan Pembelajaran</h4>
                            <button onclick="addMaterialInput()" class="text-xs bg-green-50 text-green-600 px-3 py-1 rounded hover:bg-green-100 font-bold border border-green-200">
                                <i class="fas fa-plus mr-1"></i> Tambah Bahan
                            </button>
                        </div>

                        <div id="cmsMaterialsList" class="space-y-3">
                            <!-- Input Bahan Dijana Di Sini -->
                        </div>
                        
                        <div class="mt-8 pt-4 border-t border-slate-100 flex justify-between">
                            <button onclick="deleteCurrentTopic()" class="text-red-500 text-xs font-bold hover:underline"><i class="fas fa-trash mr-1"></i> Padam Topik Ini</button>
                        </div>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="cmsEmptyState" class="flex-1 flex flex-col items-center justify-center text-slate-400 p-10 text-center">
                        <i class="fas fa-arrow-left text-3xl mb-3"></i>
                        <p>Pilih topik di sebelah kiri untuk edit.</p>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-slate-50 text-right">
                <button onclick="saveCMS()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-2 rounded-lg font-bold text-sm shadow-sm transition">
                    <i class="fas fa-save mr-2"></i> Simpan Semua Perubahan
                </button>
            </div>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="authScreen" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center">
        <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-4">SkolaHub Secure</h2>
            <button onclick="loginWithGoogle()" class="w-full bg-white border p-3 rounded-lg flex items-center justify-center gap-2 hover:bg-slate-50 font-bold text-slate-700">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Login Google
            </button>
            <div id="accessDeniedMsg" class="hidden mt-4 text-red-500 text-sm">Akses Ditolak.</div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div class="flex h-full hidden" id="mainApp">
        <!-- SIDEBAR -->
        <div class="w-64 bg-white border-r flex flex-col shadow-sm z-10">
            <div class="h-16 flex items-center px-6 font-bold text-lg border-b">SkolaHub</div>
            <div class="p-4">
                <div class="flex items-center gap-3 bg-blue-50 p-3 rounded-lg">
                    <img id="userPhoto" class="w-8 h-8 rounded-full">
                    <div class="overflow-hidden">
                        <div id="userName" class="text-sm font-bold truncate">User</div>
                        <div id="userRoleBadge" class="text-[10px] uppercase font-bold text-slate-500">Checking</div>
                    </div>
                </div>
            </div>
            <nav class="flex-1 px-2 space-y-1 mt-2">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="sidebar-link active w-full flex items-center px-4 py-3 text-sm font-medium text-slate-600 rounded hover:bg-blue-50"><i class="fas fa-chart-pie w-6"></i> Dashboard</button>
                <button onclick="switchView('builder')" id="nav-builder" class="sidebar-link w-full flex items-center px-4 py-3 text-sm font-medium text-slate-600 rounded hover:bg-blue-50"><i class="fas fa-layer-group w-6"></i> Bina Apps</button>
                <button onclick="switchView('list')" id="nav-list" class="sidebar-link w-full flex items-center px-4 py-3 text-sm font-medium text-slate-600 rounded hover:bg-blue-50"><i class="fas fa-globe w-6"></i> Senarai Apps</button>
                <button onclick="switchView('learn')" id="nav-learn" class="sidebar-link w-full flex items-center px-4 py-3 text-sm font-medium text-slate-600 rounded hover:bg-blue-50 mt-4 border-t pt-4"><i class="fas fa-graduation-cap w-6 text-green-600"></i> Pusat Belajar</button>
                <div id="adminMenu" class="hidden mt-4 pt-4 border-t">
                    <button onclick="switchView('users')" class="sidebar-link w-full flex items-center px-4 py-3 text-sm font-medium text-purple-600 rounded hover:bg-purple-50"><i class="fas fa-users-cog w-6"></i> Users</button>
                </div>
            </nav>
            <div class="p-4 border-t"><button onclick="logout()" class="text-red-500 text-sm w-full text-left px-2">Log Keluar</button></div>
        </div>

        <!-- CONTENT AREA -->
        <div class="flex-1 bg-slate-50 relative overflow-hidden flex flex-col w-full">
            <div class="h-16 bg-white border-b flex items-center justify-between px-8 shadow-sm">
                <h2 class="font-bold text-xl" id="pageTitle">Dashboard</h2>
                <button onclick="reloadData()" id="globalRefreshBtn" class="text-sm font-bold text-slate-500 hover:text-blue-600"><i class="fas fa-sync-alt mr-1"></i> Refresh</button>
            </div>

            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view-section flex-1 p-8 overflow-y-auto">
                <div class="bg-white p-6 rounded-xl shadow-sm w-full md:w-1/3">
                    <div class="text-sm text-slate-500">Total Apps</div>
                    <div class="text-4xl font-bold" id="statTotalApps">...</div>
                </div>
            </div>

            <!-- VIEW: BUILDER -->
            <div id="view-builder" class="view-section hidden flex-1 flex flex-col p-4 h-full">
                <div class="flex-1 bg-white rounded-xl border flex overflow-hidden">
                     <div class="w-1/2 bg-[#1e1e1e] flex flex-col border-r border-slate-700">
                        <div class="bg-[#252526] text-gray-400 px-4 py-2 text-xs flex justify-between"><span>HTML Editor</span><button onclick="resetBuilder()" class="hover:text-white">Reset</button></div>
                        <textarea id="htmlEditor" class="flex-1 bg-transparent text-gray-300 p-4 font-mono text-sm resize-none outline-none"></textarea>
                     </div>
                     <div class="w-1/2 bg-white flex flex-col"><div class="bg-slate-50 border-b p-3 flex gap-2"><input id="subInput" placeholder="subdomain" class="border px-2 rounded text-sm w-40 font-bold"><button onclick="publishApp()" id="btnPublish" class="bg-blue-600 text-white px-4 py-1 rounded text-xs font-bold">Terbitkan</button></div><iframe id="previewFrame" class="flex-1 border-none"></iframe></div>
                </div>
            </div>

            <!-- VIEW: APP LIST -->
            <div id="view-list" class="view-section hidden flex-1 overflow-y-auto p-8">
                <div id="appListContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-4"><div class="col-span-2 text-center text-slate-400 py-10">Loading...</div></div>
            </div>

            <!-- VIEW: USERS -->
            <div id="view-users" class="view-section hidden flex-1 overflow-y-auto p-8">
                <div class="flex gap-2 mb-4"><input id="newEmail" placeholder="Email" class="border px-3 rounded flex-1"><select id="newRole" class="border px-3 bg-white rounded"><option value="user">User</option><option value="admin">Admin</option></select><button onclick="modifyUser('add')" class="bg-purple-600 text-white px-4 rounded font-bold">Tambah</button></div>
                <div id="userListBody" class="bg-white rounded border p-4"></div>
            </div>

            <!-- VIEW: LEARNING HUB (NEW GRID SYSTEM) -->
            <div id="view-learn" class="view-section hidden flex-1 flex flex-col h-full relative">
                <!-- Admin Edit Button -->
                <button id="btnEditContent" onclick="toggleCMS(true)" class="hidden absolute top-6 right-8 bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg hover:bg-black transition z-20">
                    <i class="fas fa-edit mr-2"></i> Edit Pustaka
                </button>

                <!-- 1. GRID LEVEL (MAIN) -->
                <div id="learnGridLevel" class="flex-1 overflow-y-auto p-8">
                    <div class="flex items-center gap-3 mb-8">
                        <div class="p-3 bg-blue-100 text-blue-700 rounded-lg"><i class="fas fa-graduation-cap text-xl"></i></div>
                        <div><h2 class="text-2xl font-bold">Pustaka Pembelajaran</h2><p class="text-sm text-slate-500">Pilih topik untuk mula belajar.</p></div>
                    </div>
                    <div id="topicGrid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        <!-- Topics Injected Here -->
                    </div>
                </div>

                <!-- 2. DETAIL LEVEL (TOPIC CONTENT) -->
                <div id="learnDetailLevel" class="hidden flex-1 overflow-y-auto p-8 bg-white">
                    <button onclick="backToGrid()" class="mb-6 text-slate-500 hover:text-blue-600 text-sm font-bold flex items-center gap-2"><i class="fas fa-arrow-left"></i> Kembali ke Menu</button>
                    
                    <div class="max-w-4xl mx-auto">
                        <div class="flex items-center gap-4 mb-8 pb-6 border-b border-slate-100">
                            <div id="detailIcon" class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-3xl shadow-sm"><i class="fas fa-book"></i></div>
                            <div>
                                <h2 id="detailTitle" class="text-3xl font-bold text-slate-800">Tajuk Topik</h2>
                                <p class="text-slate-500">Senarai bahan pembelajaran untuk topik ini.</p>
                            </div>
                        </div>

                        <!-- Video Player (If Active) -->
                        <div id="activeVideoSection" class="hidden mb-10">
                            <div class="video-wrapper shadow-lg mb-2">
                                <iframe id="mainVideoPlayer" src="" frameborder="0" allowfullscreen></iframe>
                            </div>
                            <h3 id="activeVideoTitle" class="font-bold text-lg text-slate-800">Judul Video</h3>
                        </div>

                        <!-- Materials List -->
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-layer-group"></i> Bahan & Sumber</h3>
                        <div id="detailMaterials" class="grid gap-3">
                            <!-- Items Injected Here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WORKER_URL = "https://skolahub-engine.iqbalmuhaider.workers.dev";
        const firebaseConfig = { apiKey: "AIzaSyAL6_gfsCN7v8kmDqneYpBfqiJgYuzuK-Y", authDomain: "skolahubdns.firebaseapp.com", projectId: "skolahubdns", storageBucket: "skolahubdns.firebasestorage.app", messagingSenderId: "406198616120", appId: "1:406198616120:web:07b5d98a88065c06a8e6cd", measurementId: "G-XMB0V19EF5" };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();
        let currentUser = null, currentRole = null;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const res = await fetch(`${WORKER_URL}/api/auth/check`, { method: 'POST', body: JSON.stringify({ email: user.email }) });
                    const data = await res.json();
                    if (data.allowed) { currentUser = user; currentRole = data.role; initDashboard(user, data.role); } 
                    else { auth.signOut(); document.getElementById('accessDeniedMsg').classList.remove('hidden'); }
                } catch (e) { alert("Server Error"); }
            } else document.getElementById('authScreen').classList.remove('hidden');
        });

        function loginWithGoogle() { auth.signInWithPopup(provider); }
        function logout() { auth.signOut(); location.reload(); }

        function initDashboard(user, role) {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('flex');
            document.getElementById('userName').innerText = user.displayName;
            document.getElementById('userPhoto').src = user.photoURL;
            document.getElementById('userRoleBadge').innerText = role.toUpperCase();
            if(role === 'admin') {
                document.getElementById('adminMenu').classList.remove('hidden');
                document.getElementById('btnEditContent').classList.remove('hidden');
            }
            reloadData();
        }

        // --- NEW LEARNING SYSTEM LOGIC ---
        let learningData = { topics: [] }; // Structure: { topics: [ {id, title, icon, materials: []} ] }
        let currentEditingTopicId = null;

        async function loadLearning() {
            try {
                const res = await fetch(`${WORKER_URL}/api/learning`);
                const data = await res.json();
                
                // Migrate old data structure if needed
                if(data.modules && !data.topics) {
                    learningData = { topics: [] }; // Reset if old format detected
                } else {
                    learningData = data.topics ? data : { topics: [] };
                }
                renderGrid();
            } catch(e) { console.error("Error loading learning data", e); }
        }

        // 1. Render Grid Utama
        function renderGrid() {
            const grid = document.getElementById('topicGrid');
            if(learningData.topics.length === 0) {
                grid.innerHTML = `<div class="col-span-3 text-center text-slate-400 py-10 border-2 border-dashed rounded-xl">Tiada topik ditambah lagi.</div>`;
                return;
            }
            grid.innerHTML = learningData.topics.map(topic => `
                <div onclick="openTopic('${topic.id}')" class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md hover:border-blue-300 cursor-pointer transition group">
                    <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center mb-4 text-2xl group-hover:bg-blue-600 group-hover:text-white transition">
                        <i class="fas ${topic.icon || 'fa-book'}"></i>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800 mb-1 group-hover:text-blue-700">${topic.title}</h3>
                    <p class="text-xs text-slate-500">${(topic.materials || []).length} Bahan</p>
                </div>
            `).join('');
        }

        // 2. Open Detail View
        window.openTopic = (id) => {
            const topic = learningData.topics.find(t => t.id === id);
            if(!topic) return;

            document.getElementById('learnGridLevel').classList.add('hidden');
            document.getElementById('learnDetailLevel').classList.remove('hidden');
            
            document.getElementById('detailTitle').innerText = topic.title;
            document.getElementById('detailIcon').innerHTML = `<i class="fas ${topic.icon || 'fa-book'}"></i>`;
            
            // Render Materials
            const matList = document.getElementById('detailMaterials');
            document.getElementById('activeVideoSection').classList.add('hidden'); // Reset video player

            if(!topic.materials || topic.materials.length === 0) {
                matList.innerHTML = `<div class="text-slate-400 italic">Tiada bahan dalam topik ini.</div>`;
            } else {
                matList.innerHTML = topic.materials.map((m, idx) => {
                    let icon = 'fa-link';
                    let color = 'gray';
                    let action = `window.open('${m.url}', '_blank')`;
                    
                    if(m.type === 'YOUTUBE') { 
                        icon = 'fa-play'; color = 'red'; 
                        action = `playVideo('${m.url}', '${m.title}')`;
                    } else if(m.type === 'PDF') { 
                        icon = 'fa-file-pdf'; color = 'red'; 
                    } else if(m.type === 'DRIVE') { 
                        icon = 'fa-google-drive'; color = 'green'; 
                    }

                    return `
                    <div onclick="${action}" class="flex items-center gap-4 bg-slate-50 p-4 rounded-xl border border-slate-200 hover:bg-white hover:shadow-md cursor-pointer transition group">
                        <div class="w-10 h-10 bg-${color}-100 text-${color}-600 rounded-lg flex items-center justify-center text-lg">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-slate-700 group-hover:text-blue-600">${m.title}</div>
                            <div class="text-[10px] uppercase font-bold text-slate-400 tracking-wide">${m.type}</div>
                        </div>
                        <i class="fas fa-chevron-right text-slate-300 group-hover:text-blue-500"></i>
                    </div>`;
                }).join('');
            }
        };

        window.backToGrid = () => {
            document.getElementById('learnDetailLevel').classList.add('hidden');
            document.getElementById('learnGridLevel').classList.remove('hidden');
            document.getElementById('mainVideoPlayer').src = ""; // Stop video
        };

        window.playVideo = (url, title) => {
            // Extract Video ID
            let videoId = "";
            if (url.includes("youtu.be/")) videoId = url.split("youtu.be/")[1];
            else if (url.includes("youtube.com/watch?v=")) videoId = url.split("v=")[1].split("&")[0];
            else videoId = url; // Assume ID passed directly

            document.getElementById('mainVideoPlayer').src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
            document.getElementById('activeVideoTitle').innerText = title;
            document.getElementById('activeVideoSection').classList.remove('hidden');
            document.getElementById('activeVideoSection').scrollIntoView({behavior: "smooth"});
        };

        // --- CMS LOGIC ---
        
        function toggleCMS(show) {
            const modal = document.getElementById('cmsModal');
            if(show) {
                renderCMSTopicList();
                document.getElementById('cmsContentArea').classList.add('hidden');
                document.getElementById('cmsEmptyState').classList.remove('hidden');
                modal.classList.remove('hidden');
            } else { modal.classList.add('hidden'); }
        }

        function renderCMSTopicList() {
            const list = document.getElementById('cmsTopicList');
            list.innerHTML = learningData.topics.map(t => `
                <div onclick="editCMSTopic('${t.id}')" class="p-3 rounded-lg cursor-pointer hover:bg-blue-50 border border-transparent hover:border-blue-200 transition text-sm flex items-center justify-between ${currentEditingTopicId === t.id ? 'bg-blue-100 border-blue-300' : 'bg-white'}">
                    <span class="font-bold truncate"><i class="fas ${t.icon} w-6 text-slate-400"></i> ${t.title}</span>
                    <i class="fas fa-chevron-right text-xs text-slate-300"></i>
                </div>
            `).join('');
        }

        function addNewTopic() {
            const id = 'topic_' + Date.now();
            learningData.topics.push({ id: id, title: 'Topik Baru', icon: 'fa-folder', materials: [] });
            renderCMSTopicList();
            editCMSTopic(id); // Auto select
        }

        window.editCMSTopic = (id) => {
            currentEditingTopicId = id;
            const topic = learningData.topics.find(t => t.id === id);
            
            // Update UI
            document.getElementById('cmsEmptyState').classList.add('hidden');
            document.getElementById('cmsContentArea').classList.remove('hidden');
            renderCMSTopicList(); // Refresh active state

            // Populate Form
            document.getElementById('editTopicTitle').value = topic.title;
            document.getElementById('editTopicIcon').value = topic.icon;
            
            // Render Materials List
            const matList = document.getElementById('cmsMaterialsList');
            matList.innerHTML = '';
            (topic.materials || []).forEach(m => addMaterialInput(m));

            // Bind Auto Save for Title/Icon change
            document.getElementById('editTopicTitle').oninput = (e) => { topic.title = e.target.value; renderCMSTopicList(); };
            document.getElementById('editTopicIcon').oninput = (e) => { topic.icon = e.target.value; renderCMSTopicList(); };
        };

        function deleteCurrentTopic() {
            if(!confirm("Padam topik ini berserta semua bahannya?")) return;
            learningData.topics = learningData.topics.filter(t => t.id !== currentEditingTopicId);
            currentEditingTopicId = null;
            renderCMSTopicList();
            document.getElementById('cmsContentArea').classList.add('hidden');
            document.getElementById('cmsEmptyState').classList.remove('hidden');
        }

        window.addMaterialInput = (data = {type:'YOUTUBE', title:'', url:''}) => {
            const div = document.createElement('div');
            div.className = "bg-slate-50 p-3 rounded border flex gap-2 items-start";
            div.innerHTML = `
                <div class="flex-1 space-y-2">
                    <div class="flex gap-2">
                        <select class="mat-type border rounded px-2 py-1 text-xs font-bold bg-white w-28">
                            <option value="YOUTUBE" ${data.type==='YOUTUBE'?'selected':''}>YOUTUBE</option>
                            <option value="PDF" ${data.type==='PDF'?'selected':''}>EBOOK PDF</option>
                            <option value="DRIVE" ${data.type==='DRIVE'?'selected':''}>GOOGLE DRIVE</option>
                            <option value="LINK" ${data.type==='LINK'?'selected':''}>WEBSITE</option>
                        </select>
                        <input class="mat-title flex-1 border rounded px-2 py-1 text-sm font-bold" placeholder="Tajuk Bahan" value="${data.title}">
                    </div>
                    <input class="mat-url w-full border rounded px-2 py-1 text-xs text-blue-600 font-mono" placeholder="URL (Link YouTube / Drive / PDF)" value="${data.url}">
                </div>
                <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
            `;
            document.getElementById('cmsMaterialsList').appendChild(div);
        }

        async function saveCMS() {
            // Save current editing topic materials first
            if(currentEditingTopicId) {
                const topic = learningData.topics.find(t => t.id === currentEditingTopicId);
                if(topic) {
                    const divs = document.querySelectorAll('#cmsMaterialsList > div');
                    topic.materials = Array.from(divs).map(div => ({
                        type: div.querySelector('.mat-type').value,
                        title: div.querySelector('.mat-title').value,
                        url: div.querySelector('.mat-url').value
                    }));
                }
            }

            showLoading("Menyimpan...", "Mengemaskini pangkalan data.");
            try {
                const res = await fetch(`${WORKER_URL}/api/learning`, {
                    method: 'POST',
                    body: JSON.stringify({ adminEmail: currentUser.email, data: learningData })
                });
                if(res.ok) {
                    alert("Berjaya disimpan!");
                    toggleCMS(false);
                    renderGrid(); // Refresh main view
                } else alert("Gagal simpan.");
            } catch(e) { alert("Error"); }
            finally { hideLoading(); }
        }

        // --- UTILS & INIT ---
        function showLoading(t, d) { document.getElementById('globalLoader').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('globalLoader').classList.add('hidden'); }
        
        async function reloadData() {
            const btn = document.getElementById('globalRefreshBtn');
            btn.innerHTML = `<i class="fas fa-spinner fa-spin-fast text-blue-600"></i>`;
            try { await fetchApps(); loadLearning(); if(currentRole === 'admin') await fetchUsers(); } 
            finally { btn.innerHTML = `<i class="fas fa-sync-alt"></i> Refresh`; }
        }

        async function fetchApps() {
            const res = await fetch(`${WORKER_URL}/api/list?email=${currentUser.email}`);
            const apps = await res.json();
            document.getElementById('statTotalApps').innerText = apps.length;
            const container = document.getElementById('appListContainer');
            if(apps.length === 0) return container.innerHTML = `<div class="p-8 text-center text-slate-400 col-span-2 border-2 border-dashed">Tiada apps.</div>`;
            container.innerHTML = apps.map(app => `
                <div class="bg-white p-5 rounded-xl border shadow-sm flex justify-between items-center group">
                    <div>
                        <div class="font-bold text-lg text-blue-900">${app.subdomain}</div>
                        <a href="${app.url}" target="_blank" class="text-xs text-blue-500 hover:underline">${app.url}</a>
                        ${currentRole === 'admin' ? `<div class="text-[10px] text-slate-400 mt-1">Owner: ${app.owner}</div>` : ''}
                    </div>
                    <div class="flex gap-2 opacity-100 lg:opacity-0 group-hover:opacity-100 transition">
                        <button onclick="editApp('${app.subdomain}')" class="bg-yellow-100 text-yellow-700 px-3 py-2 rounded text-xs font-bold"><i class="fas fa-pen"></i></button>
                        <button onclick="deleteApp('${app.subdomain}')" class="bg-red-100 text-red-600 px-3 py-2 rounded text-xs font-bold"><i class="fas fa-trash"></i></button>
                        <a href="${app.url}" target="_blank" class="bg-slate-100 text-slate-600 px-3 py-2 rounded text-xs hover:bg-slate-200"><i class="fas fa-external-link-alt"></i></a>
                    </div>
                </div>
            `).join('');
        }
        async function deleteApp(subdomain) {
            if(!confirm(`Padam '${subdomain}'?`)) return;
            showLoading("Memadam...", "Sila tunggu.");
            try {
                const res = await fetch(`${WORKER_URL}/api/delete`, { method: 'DELETE', body: JSON.stringify({ subdomain: subdomain, requestorEmail: currentUser.email }) });
                const data = await res.json();
                if(data.success) await fetchApps(); else alert("Gagal: " + data.error);
            } finally { hideLoading(); }
        }
        async function editApp(subdomain) {
            showLoading("Loading...", "Mengambil data.");
            try {
                const res = await fetch(`${WORKER_URL}/api/get?sub=${subdomain}`);
                const data = await res.json();
                const ed = document.getElementById('htmlEditor'); ed.value = data.html; ed.dispatchEvent(new Event('input'));
                const sub = document.getElementById('subInput'); sub.value = subdomain; sub.disabled = true; sub.classList.add('bg-slate-100');
                const btn = document.getElementById('btnPublish'); btn.innerText = "Update Site"; btn.className = "bg-green-600 text-white px-4 py-1 rounded text-xs font-bold";
                switchView('builder');
            } finally { hideLoading(); }
        }
        function resetBuilder() {
            const ed = document.getElementById('htmlEditor'); ed.value = "<h1>New Site</h1>"; ed.dispatchEvent(new Event('input'));
            const sub = document.getElementById('subInput'); sub.value = ""; sub.disabled = false; sub.classList.remove('bg-slate-100');
            const btn = document.getElementById('btnPublish'); btn.innerText = "Terbitkan"; btn.className = "bg-blue-600 text-white px-4 py-1 rounded text-xs font-bold";
        }
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-'+viewId).classList.remove('hidden');
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-'+viewId).classList.add('active');
            const titles = { dashboard: 'Dashboard', builder: 'Bina Apps', list: 'Senarai Apps', users: 'Users', learn: 'Pusat Pembelajaran' };
            document.getElementById('pageTitle').innerText = titles[viewId];
            if(viewId === 'list' || viewId === 'users' || viewId === 'learn') reloadData();
        }
        function validateSub(el) { el.value = el.value.toLowerCase().replace(/[^a-z0-9-]/g, ''); }
        
        async function fetchUsers() {
            const res = await fetch(`${WORKER_URL}/api/users?email=${currentUser.email}`);
            const users = await res.json();
            let html = '';
            for(const [email, role] of Object.entries(users)) {
                html += `<div class="p-3 border-b flex justify-between items-center text-sm"><div>${email} <span class="bg-slate-200 px-1 rounded text-xs uppercase">${role}</span></div>${email !== currentUser.email ? `<button onclick="modifyUser('delete', '${email}')" class="text-red-500 text-xs">Delete</button>` : ''}</div>`;
            }
            document.getElementById('userListBody').innerHTML = html;
        }
        async function modifyUser(action, targetEmail) {
            showLoading("Updating...", "Sila tunggu.");
            try {
                const email = targetEmail || document.getElementById('newEmail').value;
                const role = document.getElementById('newRole').value;
                await fetch(`${WORKER_URL}/api/users`, { method: 'POST', body: JSON.stringify({ adminEmail: currentUser.email, action, targetEmail: email, targetRole: role }) });
                await fetchUsers();
            } finally { hideLoading(); }
        }
        async function publishApp() {
            const sub = document.getElementById('subInput').value;
            const html = document.getElementById('htmlEditor').value;
            if(!sub) return alert("Sila isi subdomain");
            showLoading("Menerbitkan Site...", "Data sedang dihantar ke server.");
            try {
                const res = await fetch(`${WORKER_URL}/api/save`, { method: 'POST', body: JSON.stringify({ subdomain: sub, html: html, ownerEmail: currentUser.email }) });
                const data = await res.json();
                if(data.success) { await fetchApps(); resetBuilder(); switchView('list'); } 
                else alert("Error: " + data.error);
            } catch(e) { alert("Network Error"); } 
            finally { hideLoading(); }
        }

        const edInit = document.getElementById('htmlEditor');
        edInit.value = "<h1>Hello!</h1>";
        edInit.addEventListener('input', () => { const blob = new Blob([edInit.value], {type:'text/html'}); document.getElementById('previewFrame').src = URL.createObjectURL(blob); });
        edInit.dispatchEvent(new Event('input'));
    </script>
</body>
</html>
