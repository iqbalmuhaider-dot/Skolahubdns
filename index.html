<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkolaHub Edu Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js untuk Graf -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        .sidebar-link.active { background-color: #eff6ff; color: #2563eb; border-right: 3px solid #2563eb; }
        .hidden { display: none !important; }
        .react-mode textarea { color: #61dafb; background: #1e1e1e; font-family: 'Menlo', monospace; }
        .html-mode textarea { color: #e2e8f0; background: #1e1e1e; font-family: 'Menlo', monospace; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fa-spin-fast { animation: spin 0.6s linear infinite; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; border-radius: 12px; overflow: hidden; background: #000; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden font-sans">

    <!-- GLOBAL LOADER -->
    <div id="globalLoader" class="hidden fixed inset-0 z-[100] bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center">
        <div class="animate-spin w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full mb-3"></div>
        <p class="text-sm font-bold text-slate-600 animate-pulse">Memproses Data...</p>
    </div>

    <!-- PREVIEW MODAL -->
    <div id="previewModal" class="hidden fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col overflow-hidden">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-lg text-slate-800">Pratonton</h3>
                <button onclick="closePreview()" class="text-slate-400 hover:text-red-500 text-2xl"><i class="fas fa-times"></i></button>
            </div>
            <iframe id="previewContentFrame" class="flex-1 bg-white border-none"></iframe>
            <textarea id="hiddenTemplateCode" class="hidden"></textarea>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="authScreen" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md text-center">
            <!-- LOGO BARU DI SINI -->
            <img src="https://i.postimg.cc/s2BpLNZw/Untitled-design.png" alt="SkolaHub Logo" class="w-32 h-auto mx-auto mb-6">
            
            <h2 class="text-2xl font-bold mb-6 text-slate-800">SkolaHub Edu Portal</h2>
            <div class="mb-4">
                <p class="text-gray-500 text-sm">Sila log masuk untuk mengakses dashboard.</p>
            </div>
            <button onclick="loginWithGoogle()" class="w-full bg-white border border-slate-300 p-3 rounded-xl flex items-center justify-center gap-3 hover:bg-slate-50 font-bold mb-3 shadow-sm transition hover:shadow-md">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Log Masuk Google
            </button>
            <div id="accessDeniedMsg" class="hidden mt-6 bg-red-50 text-red-600 p-4 rounded-lg text-sm border border-red-200">Akses Ditolak.</div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div class="flex h-full hidden" id="mainApp">
        <!-- SIDEBAR -->
        <div class="w-64 bg-white border-r flex flex-col shadow-sm z-10 flex-shrink-0">
            <!-- SIDEBAR HEADER BARU -->
            <div class="h-20 flex items-center px-6 border-b border-slate-100 bg-slate-50">
                <img src="https://i.postimg.cc/s2BpLNZw/Untitled-design.png" alt="Logo" class="h-10 w-auto mr-3">
                <div class="flex flex-col">
                    <span class="font-bold text-base text-slate-800 leading-tight">SkolaHub</span>
                    <span class="text-[10px] font-semibold text-blue-600 uppercase tracking-wide">Edu Portal</span>
                </div>
            </div>

            <div class="p-4">
                <div class="flex items-center gap-3 bg-blue-50 p-3 rounded-xl border border-blue-100">
                    <img id="userPhoto" class="w-9 h-9 rounded-full border border-white shadow-sm">
                    <div class="overflow-hidden">
                        <div id="userName" class="text-sm font-bold truncate text-slate-800">User</div>
                        <div id="userRoleBadge" class="text-[10px] uppercase font-bold text-slate-500 tracking-wider">Checking</div>
                    </div>
                </div>
            </div>
            <nav class="flex-1 px-3 space-y-1 mt-2 overflow-y-auto">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="sidebar-link active w-full flex items-center px-3 py-2.5 text-sm font-medium text-slate-600 rounded-lg hover:bg-blue-50 transition"><i class="fas fa-chart-pie w-6 text-center"></i> Dashboard</button>
                <button onclick="switchView('builder')" id="nav-builder" class="sidebar-link w-full flex items-center px-3 py-2.5 text-sm font-medium text-slate-600 rounded-lg hover:bg-blue-50 transition"><i class="fas fa-layer-group w-6 text-center"></i> Bina Apps</button>
                <button onclick="switchView('list')" id="nav-list" class="sidebar-link w-full flex items-center px-3 py-2.5 text-sm font-medium text-slate-600 rounded-lg hover:bg-blue-50 transition"><i class="fas fa-globe w-6 text-center"></i> Senarai Apps</button>
                <button onclick="switchView('templates')" id="nav-templates" class="sidebar-link w-full flex items-center px-3 py-2.5 text-sm font-medium text-slate-600 rounded-lg hover:bg-blue-50 transition"><i class="fas fa-swatchbook w-6 text-center"></i> Template</button>
                
                <div class="pt-4 mt-4 border-t border-slate-100">
                    <button onclick="switchView('learn')" id="nav-learn" class="sidebar-link w-full flex items-center px-3 py-2.5 text-sm font-medium text-slate-600 rounded-lg hover:bg-blue-50 transition"><i class="fas fa-graduation-cap w-6 text-center text-green-600"></i> Pusat Belajar</button>
                </div>

                <div id="adminMenu" class="hidden pt-4 mt-4 border-t border-slate-100">
                    <div class="px-3 text-[10px] font-bold uppercase text-slate-400 mb-2">Admin Zone</div>
                    <button onclick="switchView('approvals')" id="nav-approvals" class="sidebar-link w-full flex items-center px-3 py-2.5 text-sm font-medium text-orange-600 rounded-lg hover:bg-orange-50 transition"><i class="fas fa-check-circle w-6 text-center"></i> Kelulusan <span id="pendingBadge" class="hidden ml-auto bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">0</span></button>
                    <button onclick="switchView('users')" class="sidebar-link w-full flex items-center px-3 py-2.5 text-sm font-medium text-purple-600 rounded-lg hover:bg-purple-50 transition"><i class="fas fa-users-cog w-6 text-center"></i> Users</button>
                </div>
            </nav>
            <div class="p-4 border-t border-slate-100">
                <button onclick="logout()" class="text-red-500 hover:text-white hover:bg-red-500 text-sm font-medium w-full px-3 py-2 rounded-lg transition flex items-center justify-center gap-2 border border-red-100 hover:border-red-500">
                    <i class="fas fa-sign-out-alt"></i> Log Keluar
                </button>
            </div>
        </div>

        <!-- CONTENT AREA -->
        <div class="flex-1 bg-slate-50 relative overflow-hidden flex flex-col w-full">
            <div class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm z-10">
                <h2 class="font-bold text-xl text-slate-800" id="pageTitle">Dashboard</h2>
                <button onclick="reloadData()" id="globalRefreshBtn" class="flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-blue-600 bg-slate-50 hover:bg-blue-50 px-4 py-2 rounded-lg transition border border-slate-200">
                    <i class="fas fa-sync-alt" id="refreshIcon"></i> <span>Refresh Data</span>
                </button>
            </div>

            <!-- VIEW: DASHBOARD STATS (UPDATED) -->
            <div id="view-dashboard" class="view-section flex-1 p-8 overflow-y-auto">
                <!-- STAT CARDS -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <div class="text-slate-500 text-xs font-bold uppercase mb-1">Jumlah Aplikasi</div>
                        <div class="text-3xl font-bold text-slate-800" id="statTotal">...</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <div class="text-green-600 text-xs font-bold uppercase mb-1">Active</div>
                        <div class="text-3xl font-bold text-green-700" id="statActive">...</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <div class="text-orange-500 text-xs font-bold uppercase mb-1">Pending Review</div>
                        <div class="text-3xl font-bold text-orange-600" id="statPending">...</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <div class="text-blue-500 text-xs font-bold uppercase mb-1">Jumlah Pelawat</div>
                        <div class="text-3xl font-bold text-blue-600" id="statViews">...</div>
                    </div>
                </div>

                <!-- CHARTS AREA -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-700 mb-4">Status Aplikasi</h3>
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-700 mb-4" id="topAppsTitle">Aplikasi Paling Popular</h3>
                        <canvas id="viewsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- VIEW: ADMIN APPROVALS -->
            <div id="view-approvals" class="view-section hidden flex-1 overflow-y-auto p-8">
                <h3 class="font-bold text-lg text-slate-800 mb-4">Pengurusan Kelulusan</h3>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-3">Subdomain</th>
                                <th class="px-6 py-3">Owner</th>
                                <th class="px-6 py-3">Tarikh</th>
                                <th class="px-6 py-3 text-right">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="approvalListBody">
                            <tr><td colspan="4" class="p-6 text-center text-slate-400">Tiada permohonan pending.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: BUILDER (SAME) -->
            <div id="view-builder" class="view-section hidden flex-1 flex flex-col p-4 h-full">
                <!-- (Kod Builder Kekal Sama - Diringkaskan untuk jimat ruang) -->
                <div class="flex-1 bg-white rounded-xl border flex overflow-hidden">
                     <div class="w-1/2 bg-[#1e1e1e] flex flex-col border-r border-slate-700">
                        <div class="bg-[#252526] text-gray-400 px-4 py-2 text-xs flex justify-between h-12 items-center">
                            <span class="font-bold">HTML/React Editor</span>
                            <button onclick="resetBuilder()" class="hover:text-white"><i class="fas fa-eraser"></i> Reset</button>
                        </div>
                        <textarea id="htmlEditor" class="flex-1 bg-transparent text-gray-300 p-4 font-mono text-sm resize-none outline-none" spellcheck="false"></textarea>
                     </div>
                     <div class="w-1/2 bg-white flex flex-col">
                        <div class="bg-slate-50 border-b p-3 flex gap-2 items-center">
                            <input id="subInput" placeholder="subdomain" class="border px-3 py-1.5 rounded text-sm w-40 font-bold">
                            <button onclick="publishApp()" id="btnPublish" class="bg-blue-600 text-white px-5 py-1.5 rounded text-xs font-bold hover:bg-blue-700">Terbitkan</button>
                        </div>
                        <iframe id="previewFrame" class="flex-1 border-none bg-white"></iframe>
                     </div>
                </div>
            </div>

            <!-- VIEW: APP LIST (UPDATED WITH STATUS BADGE) -->
            <div id="view-list" class="view-section hidden flex-1 overflow-y-auto p-8">
                <div id="appListContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
            </div>

            <!-- VIEW: USERS & LEARNING & TEMPLATES (KEKAL SAMA - PLACEHOLDERS) -->
            <div id="view-users" class="view-section hidden flex-1 p-8"><div id="userListBody"></div></div>
            <div id="view-templates" class="view-section hidden flex-1 p-8"><div id="templatesGrid"></div></div>
            <div id="view-learn" class="view-section hidden flex-1 p-8"><div id="topicGrid"></div></div>
        </div>
    </div>

    <script>
        const WORKER_URL = "https://skolahub-engine.iqbalmuhaider.workers.dev";
        const firebaseConfig = { apiKey: "AIzaSyAL6_gfsCN7v8kmDqneYpBfqiJgYuzuK-Y", authDomain: "skolahubdns.firebaseapp.com", projectId: "skolahubdns", storageBucket: "skolahubdns.firebasestorage.app", messagingSenderId: "406198616120", appId: "1:406198616120:web:07b5d98a88065c06a8e6cd", measurementId: "G-XMB0V19EF5" };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();
        let currentUser = null, currentRole = null;
        let userAppsData = []; // Simpan data apps user lokal

        // AUTH LOGIC
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const res = await fetch(`${WORKER_URL}/api/auth/check`, { method: 'POST', body: JSON.stringify({ email: user.email }) });
                    const data = await res.json();
                    if (data.allowed) { currentUser = user; currentRole = data.role; initDashboard(user, data.role); } 
                    else { auth.signOut(); document.getElementById('accessDeniedMsg').classList.remove('hidden'); }
                } catch (e) { console.error(e); }
            } else document.getElementById('authScreen').classList.remove('hidden');
        });

        function loginWithGoogle() { auth.signInWithPopup(provider); }
        function logout() { auth.signOut(); location.reload(); }

        function initDashboard(user, role) {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('flex');
            document.getElementById('userName').innerText = user.displayName;
            document.getElementById('userPhoto').src = user.photoURL;
            document.getElementById('userRoleBadge').innerText = role.toUpperCase();
            if(role === 'admin') document.getElementById('adminMenu').classList.remove('hidden');
            reloadData();
        }

        // --- STATS & CHARTS ---
        let statusChartInstance = null;
        let viewsChartInstance = null;

        async function loadStats() {
            try {
                let stats = { total: 0, active: 0, pending: 0, rejected: 0, totalViews: 0, topApps: [] };

                if (currentRole === 'admin') {
                    // --- ADMIN: FETCH GLOBAL STATS DARI WORKER ---
                    const res = await fetch(`${WORKER_URL}/api/stats`);
                    stats = await res.json();
                } else {
                    // --- USER: KIRA DARI LIST APP SENDIRI ---
                    if (userAppsData.length > 0) {
                        stats.total = userAppsData.length;
                        stats.active = userAppsData.filter(a => a.status === 'active').length;
                        stats.pending = userAppsData.filter(a => a.status === 'pending').length;
                        stats.rejected = userAppsData.filter(a => a.status === 'rejected').length;
                        stats.totalViews = userAppsData.reduce((sum, app) => sum + (app.views || 0), 0);
                        
                        // Top 5 User Apps
                        stats.topApps = [...userAppsData]
                            .sort((a, b) => (b.views || 0) - (a.views || 0))
                            .slice(0, 5)
                            .map(a => ({ name: a.subdomain, views: a.views || 0 }));
                    }
                }
                
                // Update Cards
                document.getElementById('statTotal').innerText = stats.total;
                document.getElementById('statActive').innerText = stats.active;
                document.getElementById('statPending').innerText = stats.pending;
                document.getElementById('statViews').innerText = stats.totalViews;

                // Update Chart Label Title
                const chartTitle = currentRole === 'admin' ? "Aplikasi Paling Popular (Global)" : "Aplikasi Paling Popular (Anda)";
                document.getElementById('topAppsTitle').innerText = chartTitle;

                // Render Chart: Status
                const ctxStatus = document.getElementById('statusChart').getContext('2d');
                if(statusChartInstance) statusChartInstance.destroy();
                statusChartInstance = new Chart(ctxStatus, {
                    type: 'doughnut',
                    data: {
                        labels: ['Active', 'Pending', 'Rejected'],
                        datasets: [{
                            data: [stats.active, stats.pending, stats.rejected || 0],
                            backgroundColor: ['#22c55e', '#f97316', '#ef4444']
                        }]
                    }
                });

                // Render Chart: Top Apps
                const ctxViews = document.getElementById('viewsChart').getContext('2d');
                if(viewsChartInstance) viewsChartInstance.destroy();
                viewsChartInstance = new Chart(ctxViews, {
                    type: 'bar',
                    data: {
                        labels: stats.topApps.map(a => a.name),
                        datasets: [{
                            label: 'Jumlah Pelawat',
                            data: stats.topApps.map(a => a.views),
                            backgroundColor: '#3b82f6'
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });

            } catch(e) { console.error("Stats Error", e); }
        }

        // --- APPROVALS LOGIC (ADMIN) ---
        async function loadApprovals() {
            if(currentRole !== 'admin') return;
            const res = await fetch(`${WORKER_URL}/api/list?filter=pending&email=${currentUser.email}`);
            const apps = await res.json();
            
            // Update Sidebar Badge
            const badge = document.getElementById('pendingBadge');
            if(apps.length > 0) { badge.innerText = apps.length; badge.classList.remove('hidden'); } 
            else badge.classList.add('hidden');

            // Render Table
            const tbody = document.getElementById('approvalListBody');
            if(apps.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400">Tiada permohonan pending.</td></tr>'; return; }
            
            tbody.innerHTML = apps.map(app => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="px-6 py-4 font-bold text-blue-700">${app.subdomain}</td>
                    <td class="px-6 py-4 text-xs text-slate-500">${app.owner}</td>
                    <td class="px-6 py-4 text-xs text-slate-400">${new Date(app.created).toLocaleDateString()}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="previewApp('${app.subdomain}')" class="text-blue-600 hover:underline text-xs mr-3">Preview</button>
                        <button onclick="decideApp('${app.subdomain}', 'active')" class="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold hover:bg-green-200">Approve</button>
                        <button onclick="decideApp('${app.subdomain}', 'rejected')" class="bg-red-100 text-red-700 px-3 py-1 rounded text-xs font-bold hover:bg-red-200 ml-1">Reject</button>
                    </td>
                </tr>
            `).join('');
        }

        async function decideApp(subdomain, status) {
            const reason = status === 'rejected' ? prompt("Sebab penolakan?") : "";
            if(status === 'rejected' && !reason) return;

            showLoading();
            try {
                await fetch(`${WORKER_URL}/api/approve`, {
                    method: 'POST',
                    body: JSON.stringify({ adminEmail: currentUser.email, subdomain, status, rejectReason: reason })
                });
                reloadData();
            } finally { hideLoading(); }
        }

        async function previewApp(subdomain) {
            const res = await fetch(`${WORKER_URL}/api/get?sub=${subdomain}`);
            const data = await res.json();
            const blob = new Blob([data.html], {type: 'text/html'});
            document.getElementById('previewContentFrame').src = URL.createObjectURL(blob);
            document.getElementById('previewModal').classList.remove('hidden');
        }
        function closePreview() { document.getElementById('previewModal').classList.add('hidden'); }

        // --- APP LIST (USER VIEW) ---
        async function fetchApps() {
            try {
                const res = await fetch(`${WORKER_URL}/api/list?email=${currentUser.email}`);
                const apps = await res.json();
                userAppsData = apps; // SIMPAN DATA LOKAL UNTUK STATS USER
                
                const container = document.getElementById('appListContainer');
                if(apps.length === 0) return container.innerHTML = `<div class="col-span-2 text-center py-10 text-slate-400">Tiada apps.</div>`;
                
                container.innerHTML = apps.map(app => {
                    // Status Badge Logic
                    let badgeClass = "bg-green-100 text-green-700";
                    let statusText = "ACTIVE";
                    if(app.status === 'pending') { badgeClass = "bg-orange-100 text-orange-700 animate-pulse"; statusText = "PENDING REVIEW"; }
                    if(app.status === 'rejected') { badgeClass = "bg-red-100 text-red-700"; statusText = "REJECTED"; }

                    return `
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-bold text-lg text-slate-800">${app.subdomain}</div>
                            <span class="text-[10px] font-bold px-2 py-1 rounded ${badgeClass}">${statusText}</span>
                        </div>
                        <div class="text-xs text-slate-500 mb-3 flex items-center gap-4">
                            <span><i class="fas fa-eye text-blue-400"></i> ${app.views || 0} Views</span>
                            <a href="${app.url}" target="_blank" class="hover:text-blue-600 truncate">${app.url}</a>
                        </div>
                        ${app.rejectReason ? `<div class="text-xs text-red-500 bg-red-50 p-2 rounded mb-3">Sebab: ${app.rejectReason}</div>` : ''}
                        <div class="flex gap-2 border-t pt-3">
                            <button onclick="editApp('${app.subdomain}')" class="flex-1 bg-slate-50 hover:bg-slate-100 py-1.5 rounded text-xs font-bold text-slate-600">Edit</button>
                            <button onclick="deleteApp('${app.subdomain}')" class="px-3 text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                }).join('');
            } catch (e) { console.error("Fetch Apps Error", e); }
        }

        // --- CORE UTILS ---
        function showLoading() { document.getElementById('globalLoader').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('globalLoader').classList.add('hidden'); }
        
        async function reloadData() {
            const btn = document.getElementById('globalRefreshBtn');
            btn.innerHTML = `<i class="fas fa-spinner fa-spin-fast text-blue-600"></i>`;
            try {
                // PENTING: Tunggu fetchApps dulu sebab loadStats perlukan userAppsData (untuk User)
                await fetchApps(); 
                await loadStats();
                if(currentRole === 'admin') await loadApprovals();
            } catch(e) { console.error(e); }
            finally { btn.innerHTML = `<i class="fas fa-sync-alt"></i> Refresh`; }
        }

        // --- PUBLISH & DELETE (Basic) ---
        async function publishApp() {
            const sub = document.getElementById('subInput').value;
            const html = document.getElementById('htmlEditor').value;
            if(!sub) return alert("Sila isi subdomain");
            showLoading();
            try {
                const res = await fetch(`${WORKER_URL}/api/save`, { method: 'POST', body: JSON.stringify({ subdomain: sub, html: html, ownerEmail: currentUser.email }) });
                const data = await res.json();
                if(data.success) { 
                    alert(data.status === 'pending' ? "Berjaya! Site anda kini PENDING untuk kelulusan Admin." : "Berjaya! Site anda kini ACTIVE.");
                    await reloadData(); switchView('list');
                } else alert("Error: " + data.error);
            } finally { hideLoading(); }
        }

        async function deleteApp(sub) { if(confirm("Padam?")) { showLoading(); await fetch(`${WORKER_URL}/api/delete`, { method:'DELETE', body:JSON.stringify({subdomain:sub, requestorEmail:currentUser.email})}); reloadData(); hideLoading(); } }
        
        async function editApp(sub) {
            showLoading();
            const res = await fetch(`${WORKER_URL}/api/get?sub=${sub}`);
            const data = await res.json();
            document.getElementById('htmlEditor').value = data.html;
            document.getElementById('subInput').value = sub;
            switchView('builder');
            hideLoading();
        }

        function switchView(id) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            document.querySelectorAll('.sidebar-link').forEach(e => e.classList.remove('active'));
            document.getElementById('nav-'+id).classList.add('active');
            if(['dashboard','list','approvals'].includes(id)) reloadData();
        }

        // Init Editor
        const editor = document.getElementById('htmlEditor');
        editor.value = "<h1>Hello!</h1>";
        editor.addEventListener('input', () => {
             const blob = new Blob([editor.value], {type:'text/html'});
             document.getElementById('previewFrame').src = URL.createObjectURL(blob);
        });
    </script>
</body>
</html>
